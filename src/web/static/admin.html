<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BearHub Admin — Team 4068</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header>
        <img src="/static/4068Gear.jpeg" alt="Team 4068" class="team-logo">
        <div class="header-title">
            <h1>BearHub</h1>
            <span id="hub-name-badge" class="hub-badge">RedHub</span>
        </div>
        <div class="header-status">
            <span id="mode-badge" class="mode-badge mode-demo">demo</span>
            <span id="period-badge" class="period-badge" style="display:none;"></span>
            <span class="status-item">
                <span class="status-dot" id="fms-dot"></span>
                <span class="status-label">FMS</span>
            </span>
            <span class="status-item">
                <span class="status-dot" id="nt-dot"></span>
                <span class="status-label">NT</span>
            </span>
            <span class="status-item">
                <span class="status-dot" id="sacn-dot"></span>
                <span class="status-label">sACN</span>
            </span>
            <span class="status-item">
                <span class="status-dot" id="motors-dot"></span>
                <span class="status-label">Motors</span>
            </span>
        </div>
        <nav>
            <a href="/" class="nav-btn">Dashboard</a>
            <a href="/admin" class="nav-btn active">Admin</a>
            <a href="/debug" class="nav-btn">Debug</a>
        </nav>
    </header>

    <main>
        <section class="admin-section">
            <h2>Operating Mode</h2>
            <div class="mode-buttons">
                <button class="mode-btn" data-mode="fms">FMS</button>
                <button class="mode-btn" data-mode="demo">Demo</button>
                <button class="mode-btn" data-mode="robot_teleop">Robot Teleop</button>
                <button class="mode-btn" data-mode="robot_practice">Robot Practice</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>Connection Status</h2>
            <div class="conn-grid">
                <div class="conn-item">
                    <span class="status-dot" id="admin-fms-dot"></span>
                    <span>Modbus / FMS</span>
                    <span id="admin-fms-text" class="conn-status">—</span>
                </div>
                <div class="conn-item">
                    <span class="status-dot" id="admin-nt-dot"></span>
                    <span>NetworkTables</span>
                    <span id="admin-nt-text" class="conn-status">—</span>
                </div>
                <div class="conn-item">
                    <span class="status-dot" id="admin-sacn-dot"></span>
                    <span>sACN</span>
                    <span id="admin-sacn-text" class="conn-status">—</span>
                </div>
            </div>
        </section>

        <section class="admin-section">
            <h2>Pi Ethernet Address</h2>
            <div class="nt-address-row">
                <input type="text" id="eth0-address-input" class="nt-address-input"
                       placeholder="192.168.1.100/24" spellcheck="false" autocomplete="off">
                <button id="eth0-address-save" class="action-btn accent">Save</button>
            </div>
            <div id="eth0-current" style="margin-top:0.5rem;font-size:0.8rem;color:var(--text-muted);"></div>
        </section>

        <section class="admin-section">
            <h2>NetworkTables Server</h2>
            <div class="nt-address-row">
                <input type="text" id="nt-address-input" class="nt-address-input"
                       placeholder="10.40.68.2" spellcheck="false" autocomplete="off">
                <button id="nt-address-save" class="action-btn accent">Save</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>Ball Simulator</h2>
            <div class="toggle-row">
                <span class="toggle-label">Enable add ball button</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="simulator-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </section>

        <section class="admin-section">
            <h2>Motors</h2>
            <div class="nt-address-row">
                <label for="motor-speed-input" class="toggle-label">Speed (0 – 100%)</label>
                <input type="number" id="motor-speed-input" class="nt-address-input"
                       min="0" max="100" step="1" placeholder="100" style="width:6rem;">
                <button id="motor-speed-save" class="action-btn accent">Save</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>Score</h2>
            <div class="score-grid">
                <div class="score-item"><span class="score-label">Active</span><span id="adm-active">0</span></div>
                <div class="score-item"><span class="score-label">Auto</span><span id="adm-auto">0</span></div>
                <div class="score-item"><span class="score-label">Inactive</span><span id="adm-inactive">0</span></div>
            </div>
            <div class="actions" style="margin-top:1rem;">
                <button id="admin-reset-btn" class="action-btn danger">Reset Count</button>
            </div>
        </section>
    </main>

    <script src="/static/app.js"></script>
    <script>
        // Admin-page specific: mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const mode = btn.dataset.mode;
                try {
                    const res = await fetch('/api/mode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({mode})
                    });
                    const data = await res.json();
                    if (data.success) {
                        window.app && window.app.showToast(`Mode set to ${mode}`, 'success');
                    }
                } catch(e) {
                    console.error(e);
                }
            });
        });

        // Fetch current eth0 address on page load
        (async () => {
            try {
                const res = await fetch('/api/network/eth0');
                const data = await res.json();
                const input = document.getElementById('eth0-address-input');
                const current = document.getElementById('eth0-current');
                if (data.default) input.placeholder = data.default;
                if (data.address) {
                    input.value = data.address;
                    if (current) current.textContent = `Current: ${data.address}`;
                } else {
                    if (current) current.textContent = 'No address assigned';
                }
            } catch(e) { console.error(e); }
        })();

        document.getElementById('eth0-address-save').addEventListener('click', async () => {
            const address = document.getElementById('eth0-address-input').value.trim();
            if (!address) return;
            try {
                const res = await fetch('/api/network/eth0', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('eth0-current').textContent = `Current: ${address}`;
                    window.app && window.app.showToast(`Ethernet address set to ${address}`, 'success');
                } else {
                    window.app && window.app.showToast(data.error || 'Failed', 'error');
                }
            } catch(e) {
                console.error(e);
                window.app && window.app.showToast('Failed to save', 'error');
            }
        });

        document.getElementById('eth0-address-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('eth0-address-save').click();
        });

        document.getElementById('nt-address-save').addEventListener('click', async () => {
            const address = document.getElementById('nt-address-input').value.trim();
            if (!address) return;
            try {
                const res = await fetch('/api/nt-address', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await res.json();
                if (data.success) {
                    window.app && window.app.showToast(`NT server set to ${address}`, 'success');
                } else {
                    window.app && window.app.showToast(data.error || 'Failed', 'error');
                }
            } catch(e) {
                console.error(e);
                window.app && window.app.showToast('Failed to save', 'error');
            }
        });

        document.getElementById('nt-address-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('nt-address-save').click();
        });

        document.getElementById('simulator-toggle').addEventListener('change', async () => {
            try {
                await fetch('/api/simulate/toggle', {method: 'POST'});
            } catch(e) { console.error(e); }
        });

        document.getElementById('motor-speed-save').addEventListener('click', async () => {
            const pct = parseFloat(document.getElementById('motor-speed-input').value);
            if (isNaN(pct)) return;
            try {
                const res = await fetch('/api/motors/speed', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({speed: Math.max(0, Math.min(100, pct)) / 100})
                });
                const data = await res.json();
                if (data.success) {
                    window.app && window.app.showToast(`Motor speed set to ${Math.round(data.motor_speed * 100)}%`, 'success');
                }
            } catch(e) { console.error(e); }
        });

        document.getElementById('motor-speed-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('motor-speed-save').click();
        });

        document.getElementById('admin-reset-btn').addEventListener('click', async () => {
            try {
                await fetch('/api/counts/reset', {method: 'POST'});
                window.app && window.app.showToast('Counts reset', 'success');
            } catch(e) { console.error(e); }
        });
    </script>
</body>
</html>
